<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>差旅里程計算器</title>
        <meta name="app-version" content="20251124-v3">
    <link rel="manifest" href="manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; max-width: 800px; margin: 0 auto; }
        .result-card { margin-top: 20px; }
        #map { height: 300px; width: 100%; margin-top: 10px; display: none; }
        #tripHistoryTable a { text-decoration: none; color: #212529; }
        
        /* 新增：提示選單的樣式 */
        #suggestions {
            position: absolute; /* 相對於父元素定位 */
            z-index: 1000;
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #ccc;
            border-top: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .suggestion-item {
            padding: 8px 10px;
            cursor: pointer;
        }
        .suggestion-item:hover { background-color: #f8f9fa; }
        .suggestion-item.active { background-color: #e9ecef; }
    </style>

    </head>
    <body>

    <div class="mb-2 d-flex gap-2">
        <input id="addressFileInput" type="file" accept=".txt,.csv" class="form-control form-control-sm" style="max-width:320px">
        <button id="loadFileBtn" class="btn btn-sm btn-outline-primary">從檔案載入</button>
        <input id="remoteUrlInput" class="form-control form-control-sm" placeholder="遠端檔案 URL (http/https)" style="max-width:420px">
        <button id="fetchUrlBtn" class="btn btn-sm btn-outline-secondary">從 URL 載入</button>
        <button id="downloadAddressBtn" class="btn btn-sm btn-success">下載地址簿</button>
    </div>

    <!-- 已移除預設常用地址；請使用「從檔案載入」或「從 URL 載入」功能載入地址資料 -->
    <div class="mb-2 d-flex justify-content-between align-items-center">
        <div><small class="text-muted">預設地址已移除。請使用上方按鈕載入地址，或從 URL 載入。</small></div>
        <div><small id="addressCount" class="text-muted">已載入 0 筆地址</small></div>
    </div>

    <!-- 隱藏的地址簿儲存區（供載入/匯出/自動完成使用） -->
    <textarea id="addressBook" style="display:none"></textarea>

    <div class="card p-3 bg-light">
        <div class="mb-3">
            <label class="form-label">日期</label>
            <input type="date" id="tripDate" class="form-control" value="2025-11-01">
        </div>
        
        <div class="mb-3" style="position: relative;"> 
            <label class="form-label">行程 (用連字號 - 分隔)</label>
            <input type="text" id="routeInput" class="form-control" placeholder="例如: HOME-公司-電統-HOME" oninput="handleRouteInput(this)">
            <div id="suggestions"></div> </div>

        <button onclick="calculateRoute()" class="btn btn-primary w-100">計算里程並新增行程</button>
    </div>

    <div id="lastCalculationSummary" class="result-card"></div>

    <h4 class="mt-4">行程歷史紀錄 (總計)</h4>
    <div id="tripHistoryTable"></div>

    <button onclick="exportCSV()" class="btn btn-success mt-3 w-100" id="exportBtn" style="display:none;">匯出 CSV 報表</button>
    
    <div id="map"></div>

    <div class="card p-3 my-3">
        <label class="form-label">Google Maps API Key (由使用者輸入啟用地圖功能)</label>
        <div class="input-group">
            <input id="gmapsKey" class="form-control" placeholder="輸入 API Key (可儲存於 localStorage)">
            <button id="loadMapsBtn" class="btn btn-outline-primary" type="button">載入 Google Maps</button>
            <button id="clearKeyBtn" class="btn btn-outline-danger" type="button">清除金鑰</button>
        </div>
        <div class="d-flex justify-content-between mt-2">
            <div class="form-text">若已儲存金鑰，會自動填入；不輸入無法計算路線。</div>
            <div class="form-text"><small id="savedKeyStatus">未儲存金鑰</small></div>
        </div>
    </div>


    <script>
        // 註冊 PWA Service Worker（含成功/錯誤回報）
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('ServiceWorker registered:', reg))
                .catch(err => console.error('ServiceWorker register failed:', err));
        }

        // 全域變數儲存計算結果
        let tripHistory = [];
        let addressNames = []; // 儲存地址簿中的所有名稱

        // --- 新增：自動提示功能邏輯 ---

        // 解析地址簿中的所有名稱
        function parseAddressBookNames() {
             const raw = document.getElementById('addressBook').value;
             const lines = raw.trim().split('\n').filter(line => line.trim() !== '');
             addressNames = [];
             for (let line of lines) {
                 const parts = line.split(',');
                 if (parts.length >= 1 && parts[0].trim()) addressNames.push(parts[0].trim());
             }
                }
                    // 更新 UI 的已載入筆數顯示（若存在）
                    try {
                        const c = document.getElementById('addressCount');
                        if (c) c.textContent = `已載入 ${addressNames.length} 筆地址`;
                    } catch(e){}
        
        // 處理行程輸入框的輸入事件
        function handleRouteInput(inputElement) {
            const inputValue = inputElement.value;
            // 找出最後一個連字符號的位置
            const lastHyphenIndex = inputValue.lastIndexOf('-');
            
            let currentTerm; // 當前正在輸入的詞彙
            let precedingRoute; // 前面的已完成路徑 (含最後一個連字符號)

            if (lastHyphenIndex === -1) {
                currentTerm = inputValue;
                precedingRoute = "";
            } else {
                currentTerm = inputValue.substring(lastHyphenIndex + 1);
                precedingRoute = inputValue.substring(0, lastHyphenIndex + 1);
            }
            
            // 重新解析地址簿 (如果使用者修改了地址簿內容)
            parseAddressBookNames();

            // 過濾匹配的建議
            const suggestions = addressNames.filter(name => 
                name.toUpperCase().includes(currentTerm.toUpperCase()) && currentTerm.length > 0
            );

            renderSuggestions(precedingRoute, currentTerm, suggestions);
        }

        // 渲染建議清單
        function renderSuggestions(precedingRoute, currentTerm, suggestions) {
            const suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = ''; // 清空舊建議

            if (suggestions.length === 0 || currentTerm.trim().length === 0) {
                return;
            }

            const fragment = document.createDocumentFragment();
            // 只顯示前5個建議
            suggestions.slice(0, 5).forEach(name => { 
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = name;
                // 點擊後執行選取操作
                item.onclick = () => selectSuggestion(precedingRoute, name);
                fragment.appendChild(item);
            });
            
            suggestionsDiv.appendChild(fragment);
        }

        // 選擇建議
        function selectSuggestion(precedingRoute, selectedName) {
            document.getElementById('routeInput').value = precedingRoute + selectedName;
            document.getElementById('suggestions').innerHTML = ''; // 清空提示
            document.getElementById('routeInput').focus(); // 保持焦點
        }
        
        // 點擊輸入框以外的區域時，隱藏提示 (為了乾淨的 UI)
        document.addEventListener('click', (event) => {
            const suggestionsDiv = document.getElementById('suggestions');
            const routeInput = document.getElementById('routeInput');
            if (suggestionsDiv && routeInput && !routeInput.contains(event.target)) {
                suggestionsDiv.innerHTML = '';
            }
        });


        // --- 原有邏輯 (保持不變) ---

        // 動態載入 Google Maps API 的函式
        function loadGoogleMapsApi(key, callback) {
            if (!key) {
                alert('請先輸入 Google Maps API Key');
                return;
            }
            if (window.google && window.google.maps) {
                if (callback) callback();
                return;
            }
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&libraries=places`;
            script.async = true;
            script.defer = true;
            script.onload = () => {
                try { localStorage.setItem('gmaps_api_key', key); } catch(e){}
                console.log('Google Maps API loaded');
                document.getElementById('loadMapsBtn').textContent = 'API 已載入';
                document.getElementById('loadMapsBtn').disabled = true;
                if (callback) callback();
            };
            script.onerror = () => {
                alert('Google Maps API 載入失敗，請檢查 API Key 與網路設定。');
            };
            document.head.appendChild(script);
        }

        // 頁面載入時處理 API Key UI
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('gmapsKey');
            const btn = document.getElementById('loadMapsBtn');
            const clearBtn = document.getElementById('clearKeyBtn');
            const statusEl = document.getElementById('savedKeyStatus');
            try {
                const saved = localStorage.getItem('gmaps_api_key');
                if (saved) {
                    input.value = saved;
                    if (statusEl) statusEl.textContent = '已儲存金鑰';
                    loadGoogleMapsApi(saved);
                } else {
                    if (statusEl) statusEl.textContent = '未儲存金鑰';
                }
            } catch(e){}

            btn.addEventListener('click', () => {
                loadGoogleMapsApi(input.value.trim());
            });

            clearBtn.addEventListener('click', () => {
                try { localStorage.removeItem('gmaps_api_key'); } catch(e){}
                input.value = '';
                if (statusEl) statusEl.textContent = '已清除金鑰';
                window.location.reload(); 
            });

            // 確保啟動時不自動載入任何內部儲存的地址：清空隱藏的 addressBook
            try {
                const ab = document.getElementById('addressBook');
                if (ab) {
                    ab.value = ''; // 不保留上次的地址內容，僅由使用者主動載入
                }
                // 如果曾用 localStorage 儲存過地址（舊版本），一併清除
                try { localStorage.removeItem('addressBook'); } catch(e){}
                try { localStorage.removeItem('address_book'); } catch(e){}
            } catch(e){}

            // 解析（目前應為空，直到使用者載入檔案）
            parseAddressBookNames();
            renderTripHistory(); // 初始渲染空的或已儲存的歷史記錄

            // 綁定地址匯入/匯出按鈕
            const fileInput = document.getElementById('addressFileInput');
            const loadFileBtn = document.getElementById('loadFileBtn');
            const fetchUrlBtn = document.getElementById('fetchUrlBtn');
            const remoteUrlInput = document.getElementById('remoteUrlInput');
            const downloadBtn = document.getElementById('downloadAddressBtn');

            if (loadFileBtn && fileInput) {
                loadFileBtn.addEventListener('click', () => {
                    if (!fileInput.files || fileInput.files.length === 0) { alert('請選擇要載入的檔案'); return; }
                    const f = fileInput.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const text = e.target.result;
                        // 問使用者要 append 還是覆蓋
                        if (confirm('是否將檔案內容加入現有地址簿？按「確定」為加入、按「取消」為覆蓋')) {
                            document.getElementById('addressBook').value = document.getElementById('addressBook').value + '\n' + text.trim();
                        } else {
                            document.getElementById('addressBook').value = text.trim();
                        }
                        parseAddressBookNames();
                        // 載入後自動 focus 並觸發一次提示更新（如果使用者已在 routeInput 輸入）
                        try {
                            const ri = document.getElementById('routeInput');
                            if (ri) {
                                ri.focus();
                                handleRouteInput(ri);
                            }
                        } catch(e){}
                    };
                    reader.readAsText(f, 'UTF-8');
                });
            }

            if (fetchUrlBtn && remoteUrlInput) {
                fetchUrlBtn.addEventListener('click', () => {
                    const url = remoteUrlInput.value.trim();
                    if (!url) { alert('請輸入遠端檔案 URL'); return; }
                    fetch(url).then(r => {
                        if (!r.ok) throw new Error('Fetch failed: ' + r.status);
                        return r.text();
                    }).then(text => {
                        if (confirm('是否將遠端檔案內容加入現有地址簿？按「確定」為加入、按「取消」為覆蓋')) {
                            document.getElementById('addressBook').value = document.getElementById('addressBook').value + '\n' + text.trim();
                        } else {
                            document.getElementById('addressBook').value = text.trim();
                        }
                        parseAddressBookNames();
                        try {
                            const ri = document.getElementById('routeInput');
                            if (ri) {
                                ri.focus();
                                handleRouteInput(ri);
                            }
                        } catch(e){}
                    }).catch(err => alert('載入失敗：' + err.message));
                });
            }

            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => {
                    const content = document.getElementById('addressBook').value || '';
                    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'address-book.txt';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                });
            }
        });


        // 解析地址簿
        function getAddress(name) {
            const raw = document.getElementById('addressBook').value;
            const lines = raw.trim().split('\n');
            name = name.trim();
            for (let line of lines) {
                const parts = line.split(',');
                if (parts.length === 2 && parts[0].trim() === name) {
                    return parts[1].trim();
                }
            }
            return name; 
        }

        // 渲染歷史表格 (新增/移除行程後呼叫)
        function renderTripHistory() {
            const historyContainer = document.getElementById('tripHistoryTable');
            let html = `
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>行程</th>
                            <th>里程 (KM)</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            let totalKm = 0;
            
            tripHistory.forEach((trip, index) => {
                totalKm += parseFloat(trip.km);
                html += `
                    <tr>
                        <td>${trip.date}</td>
                        <td><a href="${trip.link}" target="_blank">${trip.route}</a></td>
                        <td>${trip.km}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="removeTrip(${index})">移除</button></td>
                    </tr>`;
            });
            
            html += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2"><strong>總里程合計 (KM)</strong></td>
                            <td><strong>${totalKm.toFixed(1)}</strong></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>`;
                
            historyContainer.innerHTML = html;
            
            document.getElementById('exportBtn').style.display = tripHistory.length > 0 ? 'block' : 'none';
        }

        // 移除單一行程
        function removeTrip(index) {
            if (confirm('確定要移除此行程嗎？')) {
                tripHistory.splice(index, 1);
                renderTripHistory();
            }
        }

        // 核心計算邏輯
        function calculateRoute() {
            if (!(window.google && google.maps && google.maps.DirectionsService)) {
                alert('計算里程需要 Google Maps API，請先輸入 API Key 並按「載入 Google Maps」。');
                return;
            }
            const date = document.getElementById('tripDate').value;
            const routeStr = document.getElementById('routeInput').value;
            
            if (!date || !routeStr.trim()) {
                alert('請確認日期和行程欄位已填寫');
                return;
            }
            // 確保地址簿是最新的，以防使用者在輸入前才修改
            parseAddressBookNames(); 

            const stops = routeStr.split('-');
            const directionsService = new google.maps.DirectionsService();

            const origin = getAddress(stops[0]);
            const destination = getAddress(stops[stops.length - 1]);
            const waypoints = stops.slice(1, -1).map(s => ({
                location: getAddress(s),
                stopover: true
            }));

            const request = {
                origin: origin,
                destination: destination,
                waypoints: waypoints,
                travelMode: 'DRIVING'
            };
            
            document.getElementById('lastCalculationSummary').innerHTML = `<div class="alert alert-info">計算中，請稍候...</div>`;

            directionsService.route(request, function(result, status) {
                const summaryDiv = document.getElementById('lastCalculationSummary');
                if (status == 'OK') {
                    let totalDistance = 0;
                    const myRoute = result.routes[0];
                    for (let i = 0; i < myRoute.legs.length; i++) {
                        totalDistance += myRoute.legs[i].distance.value;
                    }
                    
                    const km = (totalDistance / 1000).toFixed(1);
                    
                    // 產生 Google Maps 連結 (簡化且可用的連結)
                    // URL 格式: https://www.google.com/maps/dir/addr1/addr2/addr3
                    const addrComponents = [origin, ...waypoints.map(w => w.location), destination];
                    const mapLink = `https://www.google.com/maps/dir/${addrComponents.map(a => encodeURIComponent(a)).join('/')}`;

                    summaryDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h5>✅ ${date} 行程新增成功!</h5>
                            <p><strong>總里程:</strong> ${km} km</p>
                            <a href="${mapLink}" target="_blank" class="btn btn-sm btn-outline-primary">查看地圖</a>
                        </div>
                    `;

                    tripHistory.push({ date, route: routeStr, km, link: mapLink });
                    renderTripHistory();
                    
                    document.getElementById('routeInput').value = '';
                    
                } else {
                    summaryDiv.innerHTML = `<div class="alert alert-danger">❌ 計算失敗 (${status})，請檢查地址名稱是否在地址簿中。</div>`;
                }
            });
        }
        
        // 匯出 CSV 檔案
        function exportCSV() {
            let csvContent = "\uFEFF日期,行程,里程(KM),連結\n";
            tripHistory.forEach(row => {
                const routeClean = row.route.replace(/,/g, ';');
                csvContent += `${row.date},"${routeClean}",${row.km},${row.link}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "差旅報表_" + new Date().toISOString().split('T')[0] + ".csv");
            link.click();
        }
    </script>
</body>
</html>