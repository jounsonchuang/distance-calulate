<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·®æ—…é‡Œç¨‹è¨ˆç®—å™¨</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; max-width: 800px; margin: 0 auto; }
        .result-card { margin-top: 20px; }
        #map { height: 300px; width: 100%; margin-top: 10px; display: none; }
    </style>
</head>
<body>
    <h3>ğŸš— å·®æ—…é‡Œç¨‹è¨ˆç®—å™¨ (PWA)</h3>
    
    <div class="mb-3">
        <label class="form-label">è¨­å®šå¸¸ç”¨åœ°å€ (æ ¼å¼: åç¨±,åœ°å€)</label>
        <textarea id="addressBook" class="form-control" rows="4">
HOME,æ–°åŒ—å¸‚åœŸåŸå€ä¸­å¤®è·¯äºŒæ®µ61å··35è™Ÿ
å…¬å¸,è‡ºåŒ—å¸‚ä¸­æ­£å€å¿ å­æ±è·¯ä¸€æ®µ112è™Ÿ
é›»çµ±,è‡ºåŒ—å¸‚å…§æ¹–å€å ¤é ‚å¤§é“1æ®µ1è™Ÿ
INVENTEC,å°åŒ—å¸‚å…§æ¹–å€è¡Œå–„è·¯158è™Ÿ
Chroma,æ¡ƒåœ’å¸‚é¾œå±±å€æ–‡èŒ‚è·¯88è™Ÿ
å°é”äºŒå» ,æ¡ƒåœ’å¸‚é¾œå±±å€å±±é¶¯è·¯252è™Ÿ
</textarea>
    </div>

    <div class="card p-3 bg-light">
        <div class="mb-3">
            <label class="form-label">æ—¥æœŸ</label>
            <input type="date" id="tripDate" class="form-control">
        </div>
        <div class="mb-3">
            <label class="form-label">è¡Œç¨‹ (ç”¨é€£å­—è™Ÿ - åˆ†éš”)</label>
            <input type="text" id="routeInput" class="form-control" placeholder="ä¾‹å¦‚: HOME-å…¬å¸-é›»çµ±-HOME" value="HOME-å…¬å¸-HOME">
        </div>
        <button onclick="calculateRoute()" class="btn btn-primary w-100">è¨ˆç®—é‡Œç¨‹</button>
    </div>

    <div id="resultArea" class="result-card">
        </div>

    <button onclick="exportCSV()" class="btn btn-success mt-3 w-100" id="exportBtn" style="display:none;">åŒ¯å‡º CSV å ±è¡¨</button>
    
    <div id="map"></div>

    <!-- ä½¿ç”¨è€…è¼¸å…¥ Google Maps API Keyï¼ŒæŒ‰è¼‰å…¥å¾Œå‹•æ…‹æ³¨å…¥ Google Maps SDK -->
    <div class="card p-3 my-3">
        <label class="form-label">Google Maps API Key (ç”±ä½¿ç”¨è€…è¼¸å…¥å•Ÿç”¨åœ°åœ–åŠŸèƒ½)</label>
        <div class="input-group">
            <input id="gmapsKey" class="form-control" placeholder="è¼¸å…¥ API Key (å¯å„²å­˜æ–¼ localStorage)">
            <button id="loadMapsBtn" class="btn btn-outline-secondary">è¼‰å…¥ Google Maps</button>
            <button id="clearKeyBtn" class="btn btn-outline-danger" type="button">æ¸…é™¤é‡‘é‘°</button>
        </div>
        <div class="d-flex justify-content-between mt-2">
            <div class="form-text">è‹¥å·²å„²å­˜é‡‘é‘°ï¼Œæœƒè‡ªå‹•å¡«å…¥ï¼›ä¸è¼¸å…¥äº¦å¯ä½¿ç”¨åŸºæœ¬åŒ¯å‡ºåŠŸèƒ½ï¼Œä½†ç„¡æ³•è¨ˆç®—è·¯ç·šã€‚</div>
            <div class="form-text"><small id="savedKeyStatus">æœªå„²å­˜é‡‘é‘°</small></div>
        </div>
    </div>

    <script>
        // è¨»å†Š PWA Service Workerï¼ˆå«æˆåŠŸ/éŒ¯èª¤å›å ±ï¼‰
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('ServiceWorker registered:', reg))
                .catch(err => console.error('ServiceWorker register failed:', err));
        }

        // å‹•æ…‹è¼‰å…¥ Google Maps API çš„å‡½å¼
        function loadGoogleMapsApi(key, callback) {
            if (!key) {
                alert('è«‹å…ˆè¼¸å…¥ Google Maps API Key');
                return;
            }
            if (window.google && window.google.maps) {
                if (callback) callback();
                return;
            }
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&libraries=places`;
            script.async = true;
            script.defer = true;
            script.onload = () => {
                try { localStorage.setItem('gmaps_api_key', key); } catch(e){}
                console.log('Google Maps API loaded');
                if (callback) callback();
            };
            script.onerror = () => {
                alert('Google Maps API è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key èˆ‡ç¶²è·¯è¨­å®šã€‚');
            };
            document.head.appendChild(script);
        }

        // é é¢è¼‰å…¥æ™‚æŠŠå„²å­˜çš„ key å¡«å›è¼¸å…¥æ¡†ï¼Œä¸¦ç¶å®šè¼‰å…¥æŒ‰éˆ•
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('gmapsKey');
            const btn = document.getElementById('loadMapsBtn');
            const clearBtn = document.getElementById('clearKeyBtn');
            const statusEl = document.getElementById('savedKeyStatus');
            try {
                const saved = localStorage.getItem('gmaps_api_key');
                if (saved) {
                    input.value = saved;
                    if (statusEl) statusEl.textContent = 'å·²å„²å­˜é‡‘é‘°';
                } else {
                    if (statusEl) statusEl.textContent = 'æœªå„²å­˜é‡‘é‘°';
                }
            } catch(e){}

            btn.addEventListener('click', () => {
                loadGoogleMapsApi(input.value.trim());
            });

            clearBtn.addEventListener('click', () => {
                try { localStorage.removeItem('gmaps_api_key'); } catch(e){}
                input.value = '';
                if (statusEl) statusEl.textContent = 'å·²æ¸…é™¤é‡‘é‘°';
            });
        });

        // å…¨åŸŸè®Šæ•¸å„²å­˜è¨ˆç®—çµæœ
        let tripHistory = [];

        // è§£æåœ°å€ç°¿
        function getAddress(name) {
            const raw = document.getElementById('addressBook').value;
            const lines = raw.split('\n');
            name = name.trim();
            for (let line of lines) {
                const [key, addr] = line.split(',');
                if (key && addr && key.trim() === name) {
                    return addr.trim();
                }
            }
            return name; // æ‰¾ä¸åˆ°å°±ç›´æ¥å›å‚³åŸå
        }

        function calculateRoute() {
            // æª¢æŸ¥æ˜¯å¦å·²è¼‰å…¥ Google Maps API
            if (!(window.google && google.maps && google.maps.DirectionsService)) {
                alert('å°šæœªè¼‰å…¥ Google Maps APIï¼Œè«‹å…ˆè¼¸å…¥ API Key ä¸¦æŒ‰ã€Œè¼‰å…¥ Google Mapsã€ä»¥å•Ÿç”¨è·¯ç·šè¨ˆç®—ã€‚');
                return;
            }

            const date = document.getElementById('tripDate').value || new Date().toISOString().split('T')[0];
            const routeStr = document.getElementById('routeInput').value;
            const stops = routeStr.split('-');

            if (stops.length < 2) {
                alert("è«‹è‡³å°‘è¼¸å…¥èµ·é»å’Œçµ‚é»ï¼Œä¾‹å¦‚ A-B");
                return;
            }

            const directionsService = new google.maps.DirectionsService();
            
            // è½‰æ›åœ°å€
            const origin = getAddress(stops[0]);
            const destination = getAddress(stops[stops.length - 1]);
            const waypoints = stops.slice(1, -1).map(s => ({
                location: getAddress(s),
                stopover: true
            }));

            const request = {
                origin: origin,
                destination: destination,
                waypoints: waypoints,
                travelMode: 'DRIVING'
            };

            directionsService.route(request, function(result, status) {
                if (status == 'OK') {
                    let totalDistance = 0;
                    const myRoute = result.routes[0];
                    for (let i = 0; i < myRoute.legs.length; i++) {
                        totalDistance += myRoute.legs[i].distance.value;
                    }
                    
                    const km = (totalDistance / 1000).toFixed(1);
                    
                    // ç”¢ç”Ÿ Google Maps é€£çµ
                    const encodedStops = stops.map(s => encodeURIComponent(getAddress(s))).join('/');
                    const mapLink = `https://www.google.com/maps/dir/${encodedStops}`;

                    // é¡¯ç¤ºçµæœ
                    const resultDiv = document.getElementById('resultArea');
                    const html = `
                        <div class="alert alert-success">
                            <h5>è¨ˆç®—æˆåŠŸ!</h5>
                            <p><strong>è¡Œç¨‹:</strong> ${routeStr}</p>
                            <p><strong>ç¸½é‡Œç¨‹:</strong> ${km} km</p>
                            <a href="${mapLink}" target="_blank" class="btn btn-sm btn-outline-primary">æŸ¥çœ‹åœ°åœ–</a>
                        </div>
                    `;
                    resultDiv.innerHTML = html;

                    // å„²å­˜åˆ°æ­·å²ç´€éŒ„
                    tripHistory.push({ date, route: routeStr, km, link: mapLink });
                    document.getElementById('exportBtn').style.display = 'block';

                } else {
                    alert('è¨ˆç®—å¤±æ•—ï¼Œè«‹æª¢æŸ¥åœ°å€æ˜¯å¦æ­£ç¢º: ' + status);
                }
            });
        }

        function exportCSV() {
            let csvContent = "\uFEFFæ—¥æœŸ,è¡Œç¨‹,é‡Œç¨‹(KM),é€£çµ\n";
            tripHistory.forEach(row => {
                csvContent += `${row.date},${row.route},${row.km},${row.link}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "å·®æ—…å ±è¡¨.csv");
            link.click();
        }
    </script>
</body>
</html>